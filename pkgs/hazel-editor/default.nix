/*
nix-build .
*/

{ pkgs ? import <nixpkgs> {} }:

let
rev = "513d6b0212c8c554e809e6ad35a73b52d5dc82e1";
sha256 = "AhZfpZ+40406uupNhZwNVNcRb6Aep/4mhpvL55aG+rM=";
commitTime = "11/05/21 19:03"; # git log -1 --format=%at | xargs -I{} date -d @{} +%m/%d/%y\ %H:%M
# getting the commit time from github API is not possible, cos timezone is missing
in

pkgs.stdenv.mkDerivation {

name = "hazel";
version = "2021-11-05";

src = pkgs.fetchFromGitHub {
owner = "hazelgrove";
repo = "hazel";
inherit rev sha256;
};

# note: cant use shellHook, otherwise CAML_LD_LIBRARY_PATH is not set

buildInputs = with pkgs; [
gnumake
ocaml
opam
dune_2
] ++ (with pkgs.ocamlPackages; [
findlib
base
reason
ppx_let
ppx_sexp_conv
ppx_expect
sexplib
incr_dom
camomile
time_now
js_of_ocaml
js_of_ocaml-ppx
js_of_ocaml-compiler
]);

patchPhase = ''
cat >'src/hazelweb/Version_autogenerator.sh' <<EOF
echo "/* Auto-generated by Version_autogenerator.sh during build */"
echo let branch = \"dev\"\;
echo let commit_hash_short = \"${builtins.substring 0 7 rev}\"\;
echo let commit_time = \"${commitTime}\"\;
EOF
'';

buildPhase = "make dev";

# ${pkgs.xdg-utils}/bin/xdg-open $out/opt/hazel-editor/_build/default/src/hazelweb/www/index.html
# too simple. we want to:
# open a html file in default browser, not text editor,
# when text editor is set as default app for html files
# https://stackoverflow.com/a/69986901/10440128

installPhase = ''

mkdir -p $out/opt
cp -r . $out/opt/hazel-editor

mkdir -p $out/bin
cat >$out/bin/hazel-editor <<EOF
#!${pkgs.runtimeShell}
url=file://$out/opt/hazel-editor/_build/default/src/hazelweb/www/index.html
protocol=http
app=\$(${pkgs.xdg-utils}/bin/xdg-mime query default x-scheme-handler/\$protocol)
[ -z "\$app" ] && {
  echo "error: xdg-mime could not find default app for protocol \$protocol"
  exit 1
}
app=\$(basename \$app .desktop)
${pkgs.gnome.gtk}/bin/gtk-launch \$app "\$url"
EOF
chmod +x $out/bin/hazel-editor

'';

}
